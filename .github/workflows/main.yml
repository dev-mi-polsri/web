# GitHub Action for building and releasing a Next.js 15 standalone application

name: Build and Release Next.js App

on:
  push:
    branches: ['master']

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "Dependencies installed successfully âœ“"

      - name: Build Next.js app
        env:
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET || 'fallback-secret-for-build' }}
          DATABASE_URI: ${{ secrets.DATABASE_URI || 'file:./payload.db' }}
          NEXT_PUBLIC_SERVER_URL: ${{ vars.NEXT_PUBLIC_SERVER_URL || 'https://manajemeninformatika.polsri.ac.id' }}
          NODE_ENV: production
        run: |
          echo "Starting Next.js build..."
          echo "Environment variables:"
          echo "- NODE_ENV: $NODE_ENV"
          echo "- NEXT_PUBLIC_SERVER_URL: $NEXT_PUBLIC_SERVER_URL"
          echo "- PAYLOAD_SECRET: [REDACTED]"
          echo "- DATABASE_URI: [REDACTED]"

          pnpm build
          echo "Build completed successfully âœ“"

      - name: Running post build scripts
        run: |
          echo "ğŸš€ Running post-build script..."

          pnpm run post-build

          echo "âœ… Post-build script completed successfully"

      - name: Copy additional files
        run: |
          echo "ğŸ“ Copying additional files..."

          # Copy public directory if it exists
          if [ -d "public" ]; then
            cp -r public .next/standalone/
            echo "âœ… Copied public directory"
          else
            echo "â„¹ï¸  No public directory found, skipping..."
          fi

          # Copy .next/static directory if it exists
          if [ -d ".next/static" ]; then
            mkdir -p .next/standalone/.next
            cp -r .next/static .next/standalone/.next/
            echo "âœ… Copied .next/static directory"
          else
            echo "â„¹ï¸  No .next/static directory found, skipping..."
          fi

          echo "âœ… All file operations completed"

      - name: Package standalone output
        run: |
          echo "ğŸ“¦ Creating deployment package..."

          cd .next/standalone

          # Create the zip file
          zip -r ../../nextjs-standalone-build.zip . -x "*.log" "*.tmp"

          cd ../..

          # Verify the zip file was created
          if [ ! -f "nextjs-standalone-build.zip" ]; then
            echo "âŒ Error: Failed to create zip file"
            exit 1
          fi

          # Show zip file info
          echo "âœ… Created deployment package:"
          ls -lh nextjs-standalone-build.zip
          echo "Package contents:"
          unzip -l nextjs-standalone-build.zip | head -20

      # 11. Create a unique release tag name based on the current date and time
      - name: Create release tag
        id: create_tag
        run: |
          TAG_NAME="release-$(date +'%Y-%m-%d-%H-%M-%S')"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "ğŸ·ï¸  Created release tag: $TAG_NAME"

      # 12. Create a new GitHub Release using the updated action
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Release ${{ env.TAG_NAME }}
          body: |
            ğŸš€ **Automated Release - Next.js Standalone Application**

            This release contains a production-ready standalone build of the web-mi-polsri application.

            ## ğŸ“‹ Release Information
            - **Commit:** ${{ github.sha }}
            - **Branch:** ${{ github.ref_name }}
            - **Author:** ${{ github.actor }}
            - **Build Time:** ${{ env.TAG_NAME }}
            - **Node.js Version:** 20.x
            - **Package Manager:** pnpm 9

            ## ğŸ“¦ What's Included
            - âœ… Next.js standalone build optimized for production
            - âœ… All dependencies bundled and optimized
            - âœ… Static assets and public files
            - âœ… Server-side rendering capabilities
            - âœ… Ready for deployment

            ## ğŸš€ Deployment Instructions

            1. **Download** the `nextjs-standalone-build.zip` file
            2. **Extract** the contents to your server
            3. **Set environment variables:**
               ```bash
               export PAYLOAD_SECRET="your-secret-key"
               export DATABASE_URI="your-database-connection-string"
               export NEXT_PUBLIC_SERVER_URL="https://your-domain.com"
               ```
            4. **Run the application:**
               ```bash
               node server.js
               ```
            5. **Access** your application at `http://localhost:3000`

            ## ğŸ”§ Environment Variables Required
            - `PAYLOAD_SECRET` - Secret key for Payload CMS
            - `DATABASE_URI` - Database connection string
            - `NEXT_PUBLIC_SERVER_URL` - Public URL of your application

            ## ğŸ“ Support
            If you encounter any issues, please check the [repository documentation](https://github.com/${{ github.repository }}) or create an issue.
          files: |
            nextjs-standalone-build.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
